<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Customer Support System</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="auth-page">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>Reset Password</h1>
                <p>Enter your new password</p>
            </div>
            
            <div id="alert-container"></div>
            
            <div class="auth-form">
                <form id="resetPasswordForm" method="POST">
                    <input type="hidden" id="token" name="token" th:value="${token}">
                    
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" name="newPassword" required
                               minlength="8" pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$">
                        <p class="help-text">Password must be at least 8 characters and include uppercase, lowercase, number, and special character</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn primary-btn">Reset Password</button>
                        <a href="/auth/login" class="btn secondary-btn">Back to Login</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const resetPasswordForm = document.getElementById('resetPasswordForm');
            const newPassword = document.getElementById('newPassword');
            const confirmPassword = document.getElementById('confirmPassword');
            const token = document.getElementById('token');
            const alertContainer = document.getElementById('alert-container');
            
            // Validate token
            if (!token.value) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger';
                alert.textContent = 'Invalid or missing token. Please request a new password reset link.';
                alertContainer.appendChild(alert);
                
                // Disable form
                resetPasswordForm.querySelectorAll('input, button').forEach(el => {
                    el.disabled = true;
                });
                return;
            }
            
            // Handle form submission
            resetPasswordForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                // Clear previous alerts
                alertContainer.innerHTML = '';
                
                // Validate passwords match
                if (newPassword.value !== confirmPassword.value) {
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-danger';
                    alert.textContent = 'Passwords do not match.';
                    alertContainer.appendChild(alert);
                    return;
                }
                
                // Prepare form data
                const formData = {
                    token: token.value,
                    newPassword: newPassword.value
                };
                
                try {
                    const response = await fetch('/api/auth/password-reset', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Show success message
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-success';
                        alert.textContent = 'Password reset successfully. Redirecting to login...';
                        alertContainer.appendChild(alert);
                        
                        // Redirect to login page after 3 seconds
                        setTimeout(() => {
                            window.location.href = '/auth/login';
                        }, 3000);
                    } else {
                        // Show error message
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-danger';
                        alert.textContent = data.error || 'Failed to reset password. Please try again.';
                        alertContainer.appendChild(alert);
                    }
                } catch (error) {
                    console.error('Password reset error:', error);
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-danger';
                    alert.textContent = 'An error occurred. Please try again later.';
                    alertContainer.appendChild(alert);
                }
            });
        });
    </script>
</body>
</html>